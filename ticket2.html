<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TICKET DE VENTA</title>
    <link rel="icon" href="https://github.com/rimedhn/demo/blob/main/Logo.png?raw=true" type="image/x-icon">
    <style>
      #thermal-pos {
        box-shadow: 0 0 0mm #eee;
        margin: 0mm;
        max-width: 80mm;
        line-height: 4mm;
      }

      #thermal-pos h2 {
        font-size: 4mm;
        line-height: 13px;
      }

      #thermal-pos .label {
        text-align: center;
        font-size: 5mm;
        line-height: 1.3;
      }
      #thermal-pos .informasi {
        vertical-align: text-top;
        text-align: left;
        max-width: 45mm;
        word-wrap: break-word;
        font-size: 4mm; /* Asegurar consistencia en tamaño de fuente */
      }

      #thermal-pos .listitem {
        font-size: 4mm;
        height: 0mm; /* Esto podría ser problemático, revisar si es intencional */
        text-align: center;
      }
      #thermal-pos table {
        width: 100%;
        table-layout: fixed;
      }

      #thermal-pos .item {
        max-width: 80mm;
        font-size: 4.2mm;
        word-wrap: break-word;
        width: 100%;
      }
      #thermal-pos .amount {
        vertical-align: center;
        text-align: right;
        font-size: 4.2mm;
      }

      #thermal-pos .price {
        vertical-align: center;
        text-align: center;
        font-size: 4.2mm;
      }

      #thermal-pos .desc {
        vertical-align: center;
        text-align: center;
        font-size: 4.2mm;
      }

      #thermal-pos .qty {
        vertical-align: center;
        text-align: center;
        font-size: 4.2mm;
      }

      #thermal-pos .Isv {
        vertical-align: center;
        text-align: right;
        font-size: 4.2mm;
      }
      #thermal-pos .bawah {
        margin-top: 5mm;
        text-align: center;
        height: 90px;
        page-break-after: auto;
      }
      #thermal-pos .detail1 {
        margin-top: 5mm;
        text-align: right;
        page-break-after: auto;
        font-size: 4.2mm; /* Consistencia */
      }

      #thermal-pos .detail {
        margin-top: 5mm;
        text-align: left;
        page-break-after: auto;
        font-size: 4.2mm; /* Consistencia */
      }

      #all {
        font-family: 'Courier New', Courier, monospace; /* Fuente monoespaciada para tickets */
      }

      .mi-imagen {
        width: 150px; /* Ajustar según necesidad */
        height: auto; /* Mantener proporción */
        max-width: 60mm; /* Para que no exceda el ancho del ticket */
      }

      #thermal-pos .listitem td {
        /* width: 20%; Ya se define abajo con más especificidad */
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      #thermal-pos .descriptions {
        width: 100%;
        text-align: left;
        font-weight: bold;
        padding-top: 1px;
        padding-bottom: 1px;
        font-size: 4mm; /* Consistencia */
      }

      /* Alineación específica para cada columna */
      #thermal-pos .listitem .qty {
        width: 15%;
        text-align: left;
      }

      #thermal-pos .listitem .Price,
      #thermal-pos .listitem .Desc,
      #thermal-pos .listitem .Isv {
        width: 20%;
        text-align: center;
      }

       #thermal-pos .listitem .Price, /* Precio Unitario */
      #thermal-pos .listitem .Desc,   /* Descuento por producto */
      #thermal-pos .listitem .Isv,    /* ISV por producto */
      #thermal-pos .listitem .Amount { /* Monto total por producto */
        text-align: right; /* Alineación a la derecha para montos */
      }

      #thermal-pos .listitem .qty { /* Cantidad */
        width: 15%;
        text-align: center; /* Cantidad usualmente centrada o izquierda */
      }
      #thermal-pos .listitem .Price { width: 20%; }
      #thermal-pos .listitem .Desc  { width: 20%; }
      #thermal-pos .listitem .Isv   { width: 20%; }
      #thermal-pos .listitem .Amount{ width: 25%; }

    </style>
  </head>
  <body id="all">
    <div id="thermal-pos">
      <div class="label">
        <img src="https://github.com/rimedhn/demo/blob/main/Logo.png?raw=true" alt="Logo Empresa" class="mi-imagen" onerror="this.style.display='none'" /><br />
        <b id="empresa"></b><br />
        <b id="razon"></b>
        <div class="label">
          <b>RTN: <span id="rtn"></span></b>
          <br />
        </div>
        <div class="label">
          <b>Dirección: <span id="direccion"></span></b>
          <br />
        </div>
        <div class="label">
          <b>Teléfono: <span id="telefono"></span></b>
          <br />
        </div>
        <div class="label">
          <b id="email"></b>
          <br />
        </div>
      </div>

      <div align="center">--------------------------------------------------------</div>
      <div align="center" id="tipodoc" style="font-weight:bold; font-size: 4.5mm;"></div>
      <div align="center">--------------------------------------------------------</div>

      <table>
        <tr>
          <td class="informasi" style="width: 30%;">Factura:</td>
          <td class="informasi" style="width: 70%;" id="factura"></td>
        </tr>
        <tr>
          <td class="informasi" style="width: 30%;">Fecha:</td>
          <td class="informasi" style="width: 70%;" id="date"></td>
        </tr>
        <tr>
          <td class="informasi" style="width: 30%;">CAI:</td>
          <td class="informasi" style="width: 70%;" id="cai"></td>
        </tr>
        <tr>
          <td class="informasi" style="width: 30%;">Rango:</td>
          <td class="informasi" style="width: 70%;" id="rango"></td>
        </tr>
        <tr>
          <td class="informasi" style="width: 30%;">Límite:</td>
          <td class="informasi" style="width: 70%;" id="limite"></td>
        </tr>
      </table>
      <div align="center">--------------------------------------------------------</div>
      <div align="center" style="font-weight:bold;">Datos del cliente</div>
      <div align="center">--------------------------------------------------------</div>
      <table>
        <tr>
          <td class="informasi" style="width: 30%;">Cliente:</td>
          <td class="informasi" style="width: 70%;" id="cliente"></td>
        </tr>
        <tr>
          <td class="informasi" style="width: 30%;">RTN:</td>
          <td class="informasi" style="width: 70%;" id="rtncliente"></td>
        </tr>
        <tr>
          <td class="informasi" style="width: 30%;">Dirección:</td>
          <td class="informasi" style="width: 70%;" id="direccioncliente"></td>
        </tr>
        <tr>
          <td class="informasi" style="width: 30%;">Teléfono:</td>
          <td class="informasi" style="width: 70%;" id="telefonocliente"></td>
        </tr>
      </table>
      <div align="center">--------------------------------------------------------</div>
      <div align="center" style="font-weight:bold;">Condiciones de pago</div>
      <div align="center">--------------------------------------------------------</div>
      <table>
        <tr>
          <td class="informasi">Forma de pago:</td>
          <td class="informasi" id="formapago"></td>
        </tr>
        <tr>
          <td class="informasi">Plazo en días:</td>
          <td class="informasi" id="plazo"></td>
        </tr>
        <tr>
          <td class="informasi">Cantidad de pagos:</td>
          <td class="informasi" id="pagos"></td>
        </tr>
        <tr>
          <td class="informasi">Cuota por pago:</td>
          <td class="informasi">L <span id="cuota"></span></td>
        </tr>
      </table>
      <div align="center">--------------------------------------------------------</div>
      <div align="center" style="font-weight:bold;">Datos del cliente exonerado</div>
      <div align="center">--------------------------------------------------------</div>

      <table>
        <tr>
          <td class="informasi">O. C. Exenta:</td>
          <td class="informasi" id="ocexe"></td>
        </tr>
        <tr>
          <td class="informasi">O. C. Exonerada:</td>
          <td class="informasi" id="ocexo"></td>
        </tr>
        <tr>
          <td class="informasi">No. Reg. SAG:</td>
          <td class="informasi" id="nosag"></td>
        </tr>
      </table>
      <div align="center">--------------------------------------------------------</div>
      <div align="center" style="font-weight:bold;">Detalle</div>
      <div align="center">--------------------------------------------------------</div>

      <table>
        <tr class="listitem">
          <td style="text-align:center;"> <h2>Cant</h2>
          </td>
          <td style="text-align:right;"> <h2>Precio</h2>
          </td>
          <td style="text-align:right;"> <h2>Desc.</h2>
          </td>
          <td style="text-align:right;"> <h2>Isv</h2>
          </td>
          <td style="text-align:right;"> <h2>Monto</h2>
          </td>
        </tr>
      </table>
      <div align="center">--------------------------------------------------------</div>

      <table id="productTable">
        </table>

      <div align="center">--------------------------------------------------------</div>
      <table>
        <tr>
          <td class="detail">Subtotal</td>
          <td class="detail1">L <span id="subtotal"></span></td>
        </tr>
        <tr>
          <td class="detail">Descuento</td>
          <td class="detail1">L <span id="descuento"></span></td>
        </tr>
        <tr>
          <td class="detail">Subtotal exento:</td>
          <td class="detail1">L <span id="subtotalexe"></span></td>
        </tr>
        <tr>
          <td class="detail">Subtotal exonerado:</td>
          <td class="detail1">L <span id="subtotalexo"></span></td>
        </tr>
        <tr>
          <td class="detail">Subtotal 15%:</td>
          <td class="detail1">L <span id="subtotalisv15"></span></td>
        </tr>
        <tr>
          <td class="detail">Subtotal 18%:</td>
          <td class="detail1">L <span id="subtotalisv18"></span></td>
        </tr>
        <tr>
          <td class="detail">Impuesto 15%:</td>
          <td class="detail1">L <span id="isv15"></span></td>
        </tr>
        <tr>
          <td class="detail">Impuesto 18%:</td>
          <td class="detail1">L <span id="isv18"></span></td>
        </tr>
        <tr>
          <td class="detail" style="font-weight:bold;">Total venta:</td>
          <td class="detail1" style="font-weight:bold;">L <span id="total"></span></td>
        </tr>
        <tr>
          <td class="detail">Recibido:</td>
          <td class="detail1">L <span id="recibido"></span></td>
        </tr>
        <tr>
          <td class="detail">Cambio:</td>
          <td class="detail1">L <span id="cambio"></span></td>
        </tr>
      </table>

      <div align="center">--------------------------------------------------------</div>

      <div id="montoLetras" style="text-align: center; font-size: 3.8mm; padding: 2mm 0;"></div>

      <div align="center">--------------------------------------------------------</div>
      <div align="center" style="font-size: 3.8mm;">Gracias por su preferencia!!</div>
      <div align="center" style="font-size: 3.8mm;">Original: Cliente, Copia: Emisor</div>
      <div align="center">--------------------------------------------------------</div>

      <div style="text-align: center">
        <img alt="Código de Barras" id="barcode" style="max-width: 70mm; height: auto;" />
      </div>
      <div align="center">--------------------------------------------------------</div>
      <div
        style="
          padding-top: 8px;
          text-align: center;
          font-size: 3.5mm; /* Reducido para más información */
          font-family: Arial, sans-serif; /* Fuente más legible para info de contacto */
        "
      >
        <span>www.rmposhn.com</span><br />
        <span>indime.hn@gmail.com</span><br />
        <span>(+504) 9359-3126</span>
      </div>
    </div>

    <script>
      // Función para obtener parámetros de la URL
      function getUrlParameter(name) {
        name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
        var regex = new RegExp("[\\?&]" + name + "=([^&#]*)");
        var results = regex.exec(location.search);
        return results === null
          ? ""
          : decodeURIComponent(results[1].replace(/\+/g, " "));
      }

      // Función para formatear números como moneda (comas para miles, punto para decimal)
      function formatCurrency(value) {
        // Manejar null, undefined o string vacío retornando "0.00"
        if (value === null || value === undefined || String(value).trim() === "") {
          return "0.00";
        }

        // Intentar parsear el valor a float. Remover comas si existen.
        const number = parseFloat(String(value).replace(/,/g, ''));

        // Si el parseo falla (resulta en NaN), retornar "0.00" como fallback.
        if (isNaN(number)) {
          return "0.00";
        }

        // Formatear el número: miles con coma, decimal con punto, dos decimales fijos.
        let [integerPart, decimalPart] = number.toFixed(2).split('.');
        integerPart = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        
        return integerPart + "." + (decimalPart || "00");
      }

      // Función para establecer el contenido de texto de un elemento, con formato de moneda opcional
      function setTextContent(id, value, isCurrency = false) {
        const element = document.getElementById(id);
        if (element) {
          if (isCurrency) {
            element.textContent = formatCurrency(value);
          } else {
            element.textContent = value;
          }
        }
      }

      // Poblar el recibo con datos de los parámetros URL
      setTextContent("empresa", getUrlParameter("empresa"));
      setTextContent("razon", getUrlParameter("razon"));
      setTextContent("rtn", getUrlParameter("rtn"));
      setTextContent("direccion", getUrlParameter("direccion"));
      setTextContent("telefono", getUrlParameter("telefono"));
      setTextContent("email", getUrlParameter("email"));
      setTextContent("tipodoc", getUrlParameter("tipodoc"));
      setTextContent("factura", getUrlParameter("factura"));
      setTextContent("date", getUrlParameter("date"));
      setTextContent("cai", getUrlParameter("cai"));
      setTextContent("rango", getUrlParameter("rango"));
      setTextContent("limite", getUrlParameter("limite"));
      setTextContent("cliente", getUrlParameter("cliente"));
      setTextContent("rtncliente", getUrlParameter("rtncliente"));
      setTextContent("direccioncliente", getUrlParameter("direccioncliente"));
      setTextContent("telefonocliente", getUrlParameter("telefonocliente"));
      setTextContent("formapago", getUrlParameter("formapago"));
      setTextContent("plazo", getUrlParameter("plazo"));
      setTextContent("pagos", getUrlParameter("pagos"));
      setTextContent("ocexe", getUrlParameter("ocexe"));
      setTextContent("ocexo", getUrlParameter("ocexo"));
      setTextContent("nosag", getUrlParameter("nosag"));

      // Poblar campos de moneda con formato
      setTextContent("cuota", getUrlParameter("cuota"), true);
      setTextContent("subtotal", getUrlParameter("subtotal"), true);
      setTextContent("descuento", getUrlParameter("descuento"), true);
      setTextContent("subtotalexe", getUrlParameter("subtotalexe"), true);
      setTextContent("subtotalexo", getUrlParameter("subtotalexo"), true);
      setTextContent("subtotalisv15", getUrlParameter("subtotalisv15"), true);
      setTextContent("subtotalisv18", getUrlParameter("subtotalisv18"), true);
      setTextContent("isv15", getUrlParameter("isv15"), true);
      setTextContent("isv18", getUrlParameter("isv18"), true);
      setTextContent("total", getUrlParameter("total"), true);
      setTextContent("recibido", getUrlParameter("recibido"), true);
      setTextContent("cambio", getUrlParameter("cambio"), true);

      // Poblar tabla de productos
      var descriptions = getUrlParameter("descriptions") ? getUrlParameter("descriptions").split(",") : [];
      var quantitys = getUrlParameter("quantitys") ? getUrlParameter("quantitys").split(",") : [];
      var prices = getUrlParameter("price") ? getUrlParameter("price").split(",") : [];
      var descproductos = getUrlParameter("descproducto") ? getUrlParameter("descproducto").split(",") : [];
      var isvproductos = getUrlParameter("isvproducto") ? getUrlParameter("isvproducto").split(",") : [];
      var amounts = getUrlParameter("amounts") ? getUrlParameter("amounts").split(",") : [];

      var productTable = document.getElementById("productTable");
      if (descriptions.length > 0) {
          for (var i = 0; i < descriptions.length; i++) {
            // Crear una nueva fila para la descripción
            var descriptionRow = productTable.insertRow();
            descriptionRow.innerHTML = `
            <td colspan="5" class="descriptions">${descriptions[i] || ''}</td>
        `;

            // Crear una nueva fila para los otros detalles
            var detailsRow = productTable.insertRow();
            detailsRow.innerHTML = `
            <td class="qty">${quantitys[i] || '0'}</td>
            <td class="Price">${formatCurrency(prices[i] || '0')}</td>
            <td class="Desc">${formatCurrency(descproductos[i] || '0')}</td>
            <td class="Isv">${formatCurrency(isvproductos[i] || '0')}</td>
            <td class="Amount">${formatCurrency(amounts[i] || '0')}</td>
        `;
            detailsRow.className = "listitem"; // Aplicar clase para estilos de alineación de celdas
          }
      }


      // Código de barras
      var folioParam = getUrlParameter("Folio_1");
      if (folioParam) {
        document.getElementById("barcode").src =
          "https://barcode.tec-it.com/barcode.ashx?data=" +
          folioParam + "&code=Code128&dpi=96"; // Añadido tipo de código y dpi para mejor visualización
      } else {
        document.getElementById("barcode").style.display = 'none'; // Ocultar si no hay folio
      }
      

      // Función para convertir número a letras (Español)
      function numeroALetras(numero) {
        const unidades = [
          "", "UN", "DOS", "TRES", "CUATRO", "CINCO", "SEIS", "SIETE", "OCHO", "NUEVE", "DIEZ",
          "ONCE", "DOCE", "TRECE", "CATORCE", "QUINCE", "DIECISEIS", "DIECISIETE", "DIECIOCHO", "DIECINUEVE",
        ];
        const decenas = ["", "", "VEINTE", "TREINTA", "CUARENTA", "CINCUENTA", "SESENTA", "SETENTA", "OCHENTA", "NOVENTA"];
        const centenas = [
          "", "CIENTO", "DOSCIENTOS", "TRESCIENTOS", "CUATROCIENTOS", "QUINIENTOS", "SEISCIENTOS",
          "SETECIENTOS", "OCHOCIENTOS", "NOVECIENTOS",
        ];

        function convertirGrupo(n) {
          if (n === 0) return "";
          if (n === 100) return "CIEN";

          let resultado = "";
          if (n >= 100) {
            resultado += centenas[Math.floor(n / 100)] + " ";
            n %= 100;
          }
          if (n > 0) { // Solo procesar si n > 0 después de las centenas
            if (n < 20) {
              resultado += unidades[n];
            } else {
              resultado += decenas[Math.floor(n / 10)];
              if (n % 10 !== 0) {
                resultado += " Y " + unidades[n % 10];
              }
            }
          }
          return resultado.trim();
        }

        function convertirMiles(n) {
          if (n === 0) return "";
          if (n === 1) return "MIL";
          return convertirGrupo(n) + " MIL";
        }

        function convertirMillones(n) {
          if (n === 0) return "";
          if (n === 1) return "UN MILLON";
          return convertirGrupo(n) + " MILLONES";
        }

        if (numero === 0) return "CERO LEMPIRAS";
        if (isNaN(numero)) return "VALOR INVÁLIDO";


        let [parteEntera, parteDecimal] = String(numero.toFixed(2)).split('.').map(Number);
        
        let resultado = "";
        let esNegativo = parteEntera < 0;
        parteEntera = Math.abs(parteEntera);

        let millones = Math.floor(parteEntera / 1000000);
        let miles = Math.floor((parteEntera % 1000000) / 1000);
        let resto = parteEntera % 1000;

        if (millones > 0) {
          resultado += convertirMillones(millones) + " ";
        }
        if (miles > 0) {
          resultado += convertirMiles(miles) + " ";
        }
        if (resto > 0 || (millones === 0 && miles === 0 && parteEntera !==0) || parteEntera === 0 ) { // Asegurar que "CERO" se maneje si es el único valor entero
             if (parteEntera === 0 && resultado === "") { // Si es 0.xx
                resultado = "CERO ";
            } else if (resto > 0 || (parteEntera !== 0 && resultado === "")) {
                 resultado += convertirGrupo(resto);
            } else if (resto === 0 && resultado === "" && parteEntera === 0) { // Para el caso de 0.xx
                resultado = "CERO";
            } else {
                 resultado += convertirGrupo(resto);
            }
        }
        
        resultado = resultado.trim();
        if (esNegativo) {
          resultado = "MENOS " + resultado;
        }

        resultado += (parteEntera === 1 && millones === 0 && miles === 0) ? " LEMPIRA" : " LEMPIRAS";
        
        if (parteDecimal > 0) {
            resultado += " CON " + (parteDecimal < 10 ? "0"+parteDecimal : parteDecimal) + "/100";
        } else {
            resultado += " CON 00/100";
        }


        return resultado;
      }

      // Establecer monto en letras
      var rawTotalStr = getUrlParameter("total");
      var totalForNumeroALetras = parseFloat(String(rawTotalStr).replace(/,/g, '')); // Limpiar comas por si acaso
      if (isNaN(totalForNumeroALetras)) {
        totalForNumeroALetras = 0; // Por defecto 0 si el total no es un número válido
      }
      document.getElementById("montoLetras").textContent = "SON: " + numeroALetras(totalForNumeroALetras);

      // Disparar impresión cuando la página cargue
      window.onload = function () {
        // Podrías agregar un pequeño retraso si las imágenes o fuentes tardan en cargar
        // setTimeout(function() { window.print(); }, 500);
        window.print();
      };
    </script>
  </body>
</html>
